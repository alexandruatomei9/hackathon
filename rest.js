var mysql = require("mysql");var _ = require('underscore');function REST_ROUTER(router,connection,md5) {    var self = this;    self.handleRoutes(router,connection,md5);}REST_ROUTER.prototype.handleRoutes= function(router,connection,md5) {    router.get("/",function(req,res){        res.json({"Message" : "Hello World !"});    });		router.post("/register",function(req,res){        var query = "INSERT INTO users(email,name,surname,password) VALUES (?,?,?,?)";        var queryParams = [req.body.email,req.body.name,req.body.surname,md5(req.body.password)];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "User Added !"});            }        });    });		router.post("/login",function(req,res){        var query = "SELECT * FROM users WHERE email=?";        var queryParams = [req.body.email];        query = mysql.format(query,queryParams);		        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {			    if ( rows.length != 1 ) {					res.status(404).json({"Error" : true, "Message" : "User not found !"});				} else {					if ( _.isEqual(rows[0].password, md5(req.body.password)) ) {					    var userDetails = _.omit(rows[0], 'password');						res.status(200).json({"Error" : false, "user" : userDetails});					} else {						res.status(400).json({"Error" : true, "Message" : "Invalid credentials !"});					}				}            }        });    });		router.post("/event",function(req,res){        var query = "INSERT INTO events(name,date,creator,location,description) VALUES (?,?,?,?,?)";        var queryParams = [req.body.name, req.body.date, req.body.user_id, req.body.location, req.body.description];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {			     console.log(err);                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Event Added !"});            }        });    });		router.post("/event/:event_id",function(req,res){        var query = "INSERT INTO user_events(user_id,event_id) VALUES (?,?)";        var queryParams = [req.body.user_id,req.params.event_id];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {			     console.log(err);                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Subscribed to event !"});            }        });    });		router.delete("/event/:event_id",function(req,res){        var query = "DELETE from user_events WHERE user_id=? AND event_id = ?";        var queryParams = [req.body.user_id, req.params.event_id];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Left event with id "+req.params.event_id});            }        });    });		router.get("/events",function(req,res){        var query = "SELECT * FROM events";        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {			    var eventsCreatorsIds = _.map(rows, function(event){ return event.creator; });				eventsCreatorsIds = _.uniq(eventsCreatorsIds);				var usersQuery = "SELECT id, email, name from users where id in (?)";				var usersTable = [eventsCreatorsIds];				usersQuery = mysql.format(usersQuery,usersTable);				connection.query(usersQuery,function(err,usersResult){					if(err) {						res.json({"Error" : true, "Message" : "Error executing MySQL query"});					} else {						_.each(rows, function(row){ 							row["creator"] = _.find(usersResult, function(usr){ return usr.id == row.creator; });							return row; 							});						res.json({"Error" : false, "events" : rows});					}				});            }        });    });		router.get("/events/:user_id",function(req,res){        var query = "SELECT * FROM events where creator = ? OR id in (SELECT event_id from user_events where user_id = ?)";		var queryParams = [req.params.user_id,req.params.user_id];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {			    var eventsCreatorsIds = _.map(rows, function(event){ return event.creator; });				eventsCreatorsIds = _.uniq(eventsCreatorsIds);				var usersQuery = "SELECT id, email, name from users where id in (?)";				var usersTable = [eventsCreatorsIds];				usersQuery = mysql.format(usersQuery,usersTable);				connection.query(usersQuery,function(err,usersResult){					if(err) {						res.json({"Error" : true, "Message" : "Error executing MySQL query"});					} else {						_.each(rows, function(row){ 							row["creator"] = _.find(usersResult, function(usr){ return usr.id == row.creator; });							return row; 							});						res.json({"Error" : false, "events" : rows});					}				});            }        });    });		router.get("/preferences",function(req,res){		var query = "SELECT * FROM preferences";		        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "preferences" : rows});            }        });    });		router.get("/preferences/:user_id",function(req,res){		var query = "SELECT * FROM preferences WHERE id in (SELECT preference_id FROM user_preferences WHERE user_id=?)";		var queryParams = [req.params.user_id];		query = mysql.format(query,queryParams);		        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "preferences" : rows});            }        });    });		router.post("/preferences",function(req,res){        var query = "INSERT INTO user_preferences(user_id,preference_id) VALUES (?,?)";        var queryParams = [req.body.user_id,req.body.preference_id];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Preference Added !"});            }        });    });		router.delete("/preferences/:id",function(req,res){        var query = "DELETE from user_preferences WHERE preference_id=?";        var queryParams = [req.params.id];        query = mysql.format(query,queryParams);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Deleted the users' preference with id "+req.params.id});            }        });    });}module.exports = REST_ROUTER;