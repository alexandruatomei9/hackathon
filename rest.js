var mysql = require("mysql");var _ = require('underscore');function REST_ROUTER(router,connection,md5) {    var self = this;    self.handleRoutes(router,connection,md5);}REST_ROUTER.prototype.handleRoutes= function(router,connection,md5) {    router.get("/",function(req,res){        res.json({"Message" : "Hello World !"});    });		router.post("/register",function(req,res){        var query = "INSERT INTO ??(??,??,??) VALUES (?,?,?)";        var table = ["users","email","name","password",req.body.email,req.body.name,md5(req.body.password)];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "User Added !"});            }        });    });		router.post("/login",function(req,res){        var query = "SELECT * FROM ?? WHERE ??=?";        var table = ["users","email",req.body.email];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {			    if ( rows.length != 1 ) {					res.status(404);					res.json({"Error" : true, "Message" : "User not found !"});				} else {					if ( _.isEqual(rows[0].password, md5(req.body.password)) ) {						res.status(200);						res.json({"Error" : false, "Message" : "Login succeeded !"});					}				}            }        });    });		router.post("/event",function(req,res){        var query = "INSERT INTO ??(??,??,??) VALUES (?,?,?)";        var table = ["events","name","date", "creator",req.body.name,req.body.date,req.body.user_id];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {			     console.log(err);                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Event Added !"});            }        });    });		router.get("/events",function(req,res){        var query = "SELECT * FROM ??";        var table = ["events"];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {			    var eventsIds = _.map(rows, function(event){ return event.creator; });				var usersQuery = "SELECT id, email, name from users where id in (?)";				var usersTable = [eventsIds];				usersQuery = mysql.format(usersQuery,usersTable);				connection.query(usersQuery,function(err,usersResult){					if(err) {						res.json({"Error" : true, "Message" : "Error executing MySQL query"});					} else {						_.each(rows, function(row){ 							row["creator"] = _.find(usersResult, function(usr){ return usr.id == row.creator; });							return row; 							});						res.json({"Error" : false, "events" : rows});					}				});            }        });    });		router.get("/preferences",function(req,res){		var query = "SELECT * FROM preferences";		        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "preferences" : rows});            }        });    });		router.get("/preferences/:user_id",function(req,res){		var query = "SELECT * FROM preferences WHERE id in (SELECT preference_id FROM user_preferences WHERE user_id=?)";		var table = [req.params.user_id];		query = mysql.format(query,table);		        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "preferences" : rows});            }        });    });		router.post("/preferences",function(req,res){        var query = "INSERT INTO ??(??,??) VALUES (?,?)";        var table = ["user_preferences","user_id","preference_id",req.body.user_id,req.body.preference_id];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Preference Added !"});            }        });    });		router.delete("/preferences/:id",function(req,res){        var query = "DELETE from ?? WHERE ??=?";        var table = ["user_preferences","preference_id",req.params.id];        query = mysql.format(query,table);        connection.query(query,function(err,rows){            if(err) {                res.json({"Error" : true, "Message" : "Error executing MySQL query"});            } else {                res.json({"Error" : false, "Message" : "Deleted the users' preference with id "+req.params.id});            }        });    });}module.exports = REST_ROUTER;